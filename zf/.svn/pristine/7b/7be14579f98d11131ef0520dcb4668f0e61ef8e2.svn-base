package com.chinazhoufan.admin.modules.express.services;

import java.text.SimpleDateFormat;
import java.util.Calendar;
import java.util.Date;
import java.util.Map;

import org.slf4j.Logger;
import org.slf4j.LoggerFactory;
import org.springframework.stereotype.Service;

import com.chinazhoufan.admin.common.mpsdk4j.util.HttpTool;
import com.chinazhoufan.admin.common.utils.DateUtils;
import com.chinazhoufan.admin.modules.bus.entity.ol.SendOrder;
import com.chinazhoufan.admin.modules.bus.entity.ol.SendProduce;
import com.chinazhoufan.admin.modules.express.config.SFConfig;
import com.chinazhoufan.admin.modules.express.entity.RouteResponse;
import com.chinazhoufan.admin.modules.express.utils.SFUtils;
import com.chinazhoufan.admin.modules.sys.utils.ConfigUtils;
import com.chinazhoufan.admin.modules.sys.utils.UserUtils;
import com.chinazhoufan.api.common.express.ExpressUtil;
import com.google.common.collect.Maps;

/**
 * 顺丰快递Service
 * @author liuxiaodong
 * @date 2017-11-04
 */
@Service
public class SFService {

    private final Logger logger = LoggerFactory.getLogger(SFService.class);


    /**
     * 顺丰下单
     * @param sendOrder 发货单
     * @return
     */
    public Map<String, Object> orderService( SendOrder sendOrder){
        logger.info("----------顺丰快递下单开始----------");
        String xml="<Request service='OrderService' lang='zh-CN'>\n" +
                "<Head>%apiCode</Head>\n" +
                "<Body>\n" +
                "<Order orderid ='%orderId'\n" +
                "custid= '%custid'\n"+
/*                "j_province=%sendProv j_city=%sendCity j_county=%sendCounty\n" +*/
                "j_company='周范科技'\n" +
                "j_contact='%expressReceiverName' j_tel='%expressReceiverPhone' j_mobile='%expressReceiverPhone'\n" +
                // "d_province='%expressReceiverProv' d_city='%expressReceiverCity' d_county='%expressReceiverDistrict'\n" +
                "d_company='' \n" +
                "d_address='%sendAddress'\n" +
                "d_tel='%sendTel' d_mobile='%sendTel'\n" +
                "express_type ='1'\n" +
                "pay_method ='1'\n" +
                "sendstarttime ='%sendStartTime'\n" +
                "remark = '%remarks'>\n" +
                "%Cargos\n" +
                "</Order>\n" +
                "</Body></Request>";
        String Cargos = null;
        for(SendProduce sendProduce:sendOrder.getSendProduceList()){
            String itemXml="<Cargo name='%itemName' \n" +
                            "count='%itemNumber' unit='件' \n" +
                            "currency='CNY' source_area='中国'></Cargo>\n";
            itemXml=itemXml.replace("%itemName", sendProduce.getProduce().getName());
            itemXml=itemXml.replace("%itemNumber", sendProduce.getNum().toString());
            Cargos+=itemXml;
        }
        xml=xml.replace("%apiCode", SFConfig.API_CODE);
        xml=xml.replace("%orderId", sendOrder.getSendOrderNo());
        xml=xml.replace("%sendTel", UserUtils.getUser().getMobile());        
        xml=xml.replace("%mailno", sendOrder.getReceiveTel());
        xml=xml.replace("%sendAddress", sendOrder.getReceiveAreaStr()+sendOrder.getReceiveAreaDetail());
        xml=xml.replace("%expressReceiverName", ConfigUtils.getConfig("expressReceiverName").getConfigValue());
        xml=xml.replace("%expressReceiverPhone", ConfigUtils.getConfig("expressReceiverPhone").getConfigValue());
      /*  xml=xml.replace("%expressReceiverProv", ConfigUtils.getConfig("expressReceiverProv").getConfigValue());
        xml=xml.replace("%expressReceiverCity", ConfigUtils.getConfig("expressReceiverCity").getConfigValue());*/
        xml=xml.replace("%expressReceiverDistrict", ConfigUtils.getConfig("expressReceiverDistrict").getConfigValue());
        xml=xml.replace("%expressReceiverAddress", ConfigUtils.getConfig("expressReceiverAddress").getConfigValue());
        
        Calendar cal=Calendar.getInstance();   
        cal.set(Calendar.HOUR_OF_DAY, cal.get(Calendar.HOUR_OF_DAY) + 1);

        xml=xml.replace("%sendStartTime", DateUtils.getTimeByHour(1));
        xml=xml.replace("%Cargos", Cargos);
        xml=xml.replace("%custid", SFConfig.CUSTID);
        xml=xml.replace("%remark", sendOrder.getRemarks()==null?"无":sendOrder.getRemarks());

        Map<String , Object> map = Maps.newHashMap();
        try {
            map = SFUtils.resolveResponse(HttpTool.post(SFConfig.API_URL, "xml="+xml+"&verifyCode="+ ExpressUtil.generateData(xml, SFConfig.API_CHECKWORD)));
            logger.info("----------顺丰快递下单成功----------");
        } catch (Exception e){
            e.printStackTrace();
            map.put("result", "ERROR");
        }
        return map;
    }

    /**
     * 查询顺丰物流信息
     * @param expressNo
     * @return
     */
    public RouteResponse sfexpressService(String expressNo) {
        String xml = "<Request service='RouteService' lang='zh-CN'>\n" +
                "<Head>%apiCode</Head>\n" +
                "<Body>\n" +
                "<RouteRequest\n" +
                "tracking_number=%expressNo/>\n" +
                "</Body>\n" +
                "</Request>";
        xml=xml.replace("%apiCode", SFConfig.API_CODE);
        xml=xml.replace("%expressNo", expressNo);
        RouteResponse routeResponse = null;
        try {
            routeResponse = SFUtils.resolveExpressResponse(HttpTool.post(SFConfig.API_URL, "xml="+xml+"&verifyCode="+ExpressUtil.generateData(xml, SFConfig.API_CHECKWORD)));
        } catch (Exception e){

        }
        return routeResponse;

    }
    
   /* public static void main(String[] args){
        String   xml="<Request service='OrderService' lang='zh-CN'>\n" +
                "<Head>%apiCode</Head>\n" +
                "<Body>\n" +
                "<Order orderid = '%orderId'\n" +
                "j_tel='%sendTel' j_mobile='%sendTel'\n" +
                "j_province=%sendProv j_city=%sendCity j_county=%sendCounty\n" +
                "j_address='%sendAddress'\n" +
                "d_company=''\n" +
                "d_contact='%expressReceiverName' d_tel='%expressReceiverPhone' d_mobile='%expressReceiverPhone'\n" +
               // "d_province='%expressReceiverProv' d_city='%expressReceiverCity' d_county='%expressReceiverDistrict'\n" +
                "d_address='%expressReceiverAddress'\n" +
                "express_type ='1'\n" +
                "pay_method ='3'\n" +
                "sendstarttime ='%sendStartTime'\n" +
                "remark = '%remarks'>\n" +
                "%Cargos\n" +
                "</Order>\n" +
                "</Body></Request>";

        String reverseXml = "<Request service='OrderReverseService' lang='zh-CN'>\n" +
                "<Head>HZZFKJ</Head>\n" +
                "<Body>\n" +
                "<Order orderid=\"ZF10160423123045\" j_company=\"唯品会\" j_contact=\"代运营\" j_tel=\"020-28351154\" j_mobile=\"020-28351154\" j_province=\"广东省\" j_city=\"广州市\" j_county=\"荔湾区\" j_address=\"长堤街7号\" d_company=\"个人\" d_contact=\"testczc \" d_tel=\"15820370000\" d_mobile=\"15820370000\" d_province=\"上海市\" d_city=\"上海市\" d_county=\"静安区\" d_address=\"啦啦啦啦啦啦\" express_type=\"1\" pay_method=\"3\" custid=\"9999999999\" parcel_quantity=\"1\" cargo_total_weight=\"1\" sendstarttime=\"2017-11-02 15:49:32\" order_souce=\"唯品会\" remark=\"\">\n" +
                "<Cargo name=\"KROOLEY JOGGJEANS 0685G\" count=\"1\" unit=\"件\" weight=\"0.0000\" amount=\"999999.0000\" currency=\"CNY\" source_area=\"中国\"/>\n" +
                "<AddedService name='INSURE' value='9999'></AddedService>\n" +
                "</Order></Body></Request>";

        String Cargos = null;
        for(int i=0;i<3;i++){
            String itemXml="<Cargo Name='%itemName' \n" +
                    "count='%itemNumber' unit='件' \n" +
                    "currency='CNY' source_area='中国'></Cargo>\n";
            itemXml=itemXml.replace("%itemName", "戒指"+i);
            itemXml=itemXml.replace("%itemNumber", i+"");
            Cargos+=itemXml;
        }
        xml=xml.replace("%apiCode", SFConfig.API_CODE);
        xml=xml.replace("%orderId", "FH16608078190");
        xml=xml.replace("%sendTel", "13812341234");
        xml=xml.replace("%sendAddress", "浙江省杭州市拱墅区小河路480号");
        xml=xml.replace("%expressReceiverName", "浙江省");
        xml=xml.replace("%expressReceiverPhone", "13513241234");
        xml=xml.replace("%expressReceiverProv", "浙江省");
        xml=xml.replace("%expressReceiverCity", "杭州市");
        xml=xml.replace("%expressReceiverDistrict", "拱墅区");
        xml=xml.replace("%expressReceiverAddress", "浙江省杭州市拱墅区小河路480号");


        xml=xml.replace("%sendStartTime", "2017-11-07 12:00:00");
        xml=xml.replace("%Cargos", Cargos);
        xml=xml.replace("%remark", "hahah");

        try {
            System.out.println(ExpressUtil.generateData(reverseXml, SFConfig.API_CHECKWORD));

            String result1 = HttpTool.post(SFConfig.API_URL, "xml="+xml+"&verifyCode="+ExpressUtil.generateData(xml, SFConfig.API_CHECKWORD));

//            String result = HttpTool.post(SFConfig.API_URL, "xml="+reverseXml+"&verifyCode="+ExpressUtil.generateData(reverseXml, SFConfig.API_CHECKWORD));


//            System.out.println(SFUtils.resolveResponse(result));



        } catch (Exception e) {
            e.printStackTrace();
        }




    }
*/
}
