<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.chinazhoufan.admin.modules.lgt.dao.po.PurchaseOrderDao">
    
	<sql id="purchaseOrderColumns">
		a.id AS "id",
		a.purchase_mission_id AS "purchaseMission.id",
		a.order_no AS "orderNo",
		a.order_status AS "orderStatus",
		a.supplier_id AS "supplier.id",
		a.purchase_user_id AS "purchaseUser.id",
		a.payable_amount AS "payableAmount",
		a.paid_amount AS "paidAmount",
		a.required_time AS "requiredTime",
		a.finish_time AS "finishTime",
		a.clearing_goldprice AS "clearingGoldprice",
		a.check_by AS "checkBy.id",
		a.check_time AS "checkTime",
		a.check_remarks AS "checkRemarks",
		a.create_by AS "createBy.id",
		a.create_date AS "createDate",
		a.update_by AS "updateBy.id",
		a.update_date AS "updateDate",
		a.remarks AS "remarks",
		a.del_flag AS "delFlag"
	</sql>
	
	<sql id="purchaseOrderJoins">
	</sql>
	
	<select id="get" resultType="PurchaseOrder">
		SELECT 
			<include refid="purchaseOrderColumns"/>
		FROM lgt_po_purchase_order a
		<include refid="purchaseOrderJoins"/>
		WHERE a.id = #{id}
	</select>
	
	<!-- 查询采购任务以及包含的采购产品 -->
	<resultMap id="WithPurchaseProducesResult" type="com.chinazhoufan.admin.modules.lgt.entity.po.PurchaseOrder">
		<result property="id" 						column="id"/>
		<result property="purchaseMission.id" 		column="purchaseMission.id"/>
		<result property="purchaseMission.batchNo" 	column="purchaseMission.batchNo"/>
		<result property="orderNo" 					column="orderNo"/>
		<result property="orderStatus" 				column="orderStatus"/>
		<result property="supplier.id" 				column="supplier.id"/>
		<result property="supplier.name"            column="supplier.name"/>
		<result property="purchaseUser.id" 			column="purchaseUser.id"/>
		<result property="payableAmount" 			column="payableAmount"/>
		<result property="paidAmount" 				column="paidAmount"/>
		<result property="requiredTime" 			column="requiredTime"/>
		<result property="finishTime" 				column="finishTime"/>
		<result property="clearingGoldprice" 		column="clearingGoldprice"/>
		
		<result property="checkBy.id"               column="checkBy.id"/>
        <result property="checkTime"                column="checkTime"/>
        <result property="checkRemarks"             column="checkRemarks"/>
		
		<result property="createBy.id" 				column="createBy.id"/>
		<result property="createDate" 				column="createDate"/>
		<result property="updateBy.id" 				column="updateBy.id"/>
		<result property="updateDate" 				column="updateDate"/>
		<result property="remarks" 					column="remarks"/>
		<result property="delFlag" 					column="delFlag"/>
		<collection property="purchaseProduceList" ofType="PurchaseProduce">
			<result property="id" 					column="lppp.id"/>
			<result property="produce.id" 			column="produce.id"/>
			<result property="produce.code"	 		column="produce.code"/>
			<result property="produce.name"	 		column="produce.name"/>
			<result property="produce.goods.id"    column="produce.goods.id"/>
			<result property="produce.goods.name"	column="produce.goods.name"/>
			<result property="requiredNum" 			column="lppp.requiredNum"/>
			<result property="realityNum" 			column="lppp.realityNum"/>
			<result property="realityPrice" 		column="lppp.realityPrice"/>
			
			<result property="inNum"               column="lppp.inNum"/>
            <result property="backNum"             column="lppp.backNum"/>
            <result property="goldPrice"           column="lppp.goldPrice"/>
            <result property="lossFee"             column="lppp.lossFee"/>
            <result property="goldWeight"          column="lppp.goldWeight"/>
            <result property="mainStoneWeight"     column="lppp.mainStoneWeight"/>
            
            <result  property="electrolyticGoldCrafts"   column="lppp.electrolyticGoldCrafts"/>
            <result  property="electrolyticGoldColour"   column="lppp.electrolyticGoldColour"/>
            <result  property="electrolyticGoldThickness"   column="lppp.electrolyticGoldThickness"/>
            <result  property="electrolyticGoldPrice"   column="lppp.electrolyticGoldPrice"/>
            
            <result property="mainStonePrice"               column="lppp.mainStonePrice"/>
            <result property="subsidiaryStoneWeight"             column="lppp.subsidiaryStoneWeight"/>
            <result property="subsidiaryStonePrice"           column="lppp.subsidiaryStonePrice"/>
            <result property="workFee"             column="lppp.workFee"/>
            <result property="inlayFee"          column="lppp.inlayFee"/>
            <result property="inlayNum"          column="lppp.inlayNum"/>
            <result property="templetFee"     column="lppp.templetFee"/>
			
			<result property="remarks" column="lppp.remarks"/>
		</collection>
	</resultMap>
	<select id="getWithPurchaseProduces" resultMap="WithPurchaseProducesResult">
		SELECT
			a.id 					AS "id",
			a.purchase_mission_id 	AS "purchaseMission.id",
			lppm.batch_no 			AS "purchaseMission.batchNo",
			a.order_no 				AS "orderNo",
			a.order_status 			AS "orderStatus",
			a.supplier_id 			AS "supplier.id",
			s.name                   AS "supplier.name",
			a.purchase_user_id 		AS "purchaseUser.id",
			a.payable_amount 		AS "payableAmount",
			a.paid_amount 			AS "paidAmount",
			a.required_time 		AS "requiredTime",
			a.finish_time 			AS "finishTime",
			a.clearing_goldprice 	AS "clearingGoldprice",
			a.check_by              AS "checkBy.id",
            a.check_time             AS "checkTime",
            a.check_remarks          AS "checkRemarks",
			a.create_by 			AS "createBy.id",
			a.create_date 			AS "createDate",
			a.update_by 			AS "updateBy.id",
			a.update_date 			AS "updateDate",
			a.remarks 				AS "remarks",
			a.del_flag 				AS "delFlag",		
			lppp.id 					AS "lppp.id",
			lppp.produce_id  			AS "produce.id",
			lpp.code 					AS "produce.code",
			lpp.name 					AS "produce.name",
			lpp.price_purchase          AS "produce.pricePurchase",
			lpg.id                      AS "produce.goods.id",
			lpg.name 					AS "produce.goods.name",
			lppp.required_num 			AS "lppp.requiredNum",
			lppp.reality_num 			AS "lppp.realityNum",
			lppp.reality_price 			AS "lppp.realityPrice",
			
			
			lppp.in_num                 AS "lppp.inNum",
            lppp.back_num               AS "lppp.backNum",
            lppp.gold_price             AS "lppp.goldPrice",
            lppp.loss_fee               AS "lppp.lossFee", 
            lppp.gold_weight            AS "lppp.goldWeight",
            
            
            lppp.electrolytic_gold_crafts AS "lppp.electrolyticGoldCrafts",
        
            lppp.electrolytic_gold_colour AS "lppp.electrolyticGoldColour",
        
            lppp.electrolytic_gold_thickness AS "lppp.electrolyticGoldThickness",
        
            lppp.electrolytic_gold_price AS "lppp.electrolyticGoldPrice", 
            
            
            
            lppp.main_stone_weight      AS "lppp.mainStoneWeight", 
            lppp.main_stone_price       AS "lppp.mainStonePrice",   
            lppp.subsidiary_stone_weight    AS "lppp.subsidiaryStoneWeight",
            lppp.subsidiary_stone_price     AS "lppp.subsidiaryStonePrice",
            lppp.work_fee               AS "lppp.workFee",
            lppp.inlay_fee              AS "lppp.inlayFee",
            lppp.inlay_num              AS "lppp.inlayNum",
            lppp.templet_fee            AS "lppp.templetFee",
			
			lppp.remarks                AS "lppp.remarks"
			
			
		FROM lgt_po_purchase_order a
		LEFT JOIN lgt_po_purchase_mission lppm 	ON lppm.id=a.purchase_mission_id
		LEFT JOIN lgt_si_supplier s             ON s.id=a.supplier_id
		LEFT JOIN lgt_po_purchase_produce lppp 	ON lppp.purchase_order_id=a.id AND lppp.del_flag = '0'
		LEFT JOIN lgt_ps_produce lpp 			ON lpp.id=lppp.produce_id
		LEFT JOIN lgt_ps_goods lpg 				ON lpg.id=lpp.goods_id
		WHERE a.id = #{id}
	</select>

	<!-- 查询采购任务以及包含的采购产品、采购货品信息 -->
	<resultMap id="WithPurchaseProducesAndPurchaseProductsResult" type="com.chinazhoufan.admin.modules.lgt.entity.po.PurchaseOrder">
		<result property="id" 						column="id"/>
		<result property="purchaseMission.id" 		column="purchaseMission.id"/>
		<result property="purchaseMission.batchNo" 	column="purchaseMission.batchNo"/>
		
		<result property="purchaseMission.checkBy.id"    column="purchaseMission.checkBy.id"/>
		<result property="purchaseMission.checkTime"    column="purchaseMission.checkTime"/>
		<result property="purchaseMission.checkRemarks"    column="purchaseMission.checkRemarks"/>
		
		
		<result property="orderNo" 					column="orderNo"/>
		<result property="orderStatus" 				column="orderStatus"/>
		<result property="supplier.id" 				column="supplier.id"/>
		<result property="supplier.name" 			column="supplier.name"/>
		<result property="purchaseUser.id" 			column="purchaseUser.id"/>
		<result property="payableAmount" 			column="payableAmount"/>
		<result property="paidAmount" 				column="paidAmount"/>
		<result property="requiredTime" 			column="requiredTime"/>
		<result property="finishTime" 				column="finishTime"/>
		<result property="receiveTime"               column="receiveTime"/>
		<result property="clearingGoldprice" 		column="clearingGoldprice"/>
		
		<result property="checkBy.id"               column="checkBy.id"/>
        <result property="checkTime"                column="checkTime"/>
        <result property="checkRemarks"             column="checkRemarks"/>
		
		<result property="createBy.id" 				column="createBy.id"/>
		<result property="createDate" 				column="createDate"/>
		<result property="updateBy.id" 				column="updateBy.id"/>
		<result property="updateDate" 				column="updateDate"/>
		<result property="remarks" 					column="remarks"/>
		<result property="delFlag" 					column="delFlag"/>
		<collection property="purchaseProduceList" 		ofType="PurchaseProduce">
			<result property="id" 						column="lppp.id"/>
			<result property="purchaseOrder.id" 		column="lppp.purchaseOrder.id"/>
			<result property="produce.id" 				column="produce.id"/>
			<result property="produce.code"	 			column="produce.code"/>
			<result property="produce.name"	 			column="produce.name"/>
			<result property="produce.title"	 			column="produce.title"/>
			<result property="produce.priceSrc"	 			column="produce.priceSrc"/>
			<result property="produce.pricePurchase"     column="produce.pricePurchase"/>
			
			<result property="produce.goods.id"         column="produce.goods.id"/>
			<result property="produce.goods.name"		column="produce.goods.name"/>
			<result property="produce.goods.title"		column="produce.goods.title"/>
			<result property="produce.goods.samplePhoto" column="produce.goods.samplePhoto"/>
			<result property="produce.goods.category.id" column="produce.goods.category.id"/>
			
			
			<result property="requiredNum" 				column="lppp.requiredNum"/>
			<result property="realityNum" 				column="lppp.realityNum"/>
			<result property="realityPrice" 			column="lppp.realityPrice"/>
			
			<result property="inNum"               column="lppp.inNum"/>
            <result property="backNum"             column="lppp.backNum"/>
            <result property="goldPrice"           column="lppp.goldPrice"/>
            <result property="lossFee"             column="lppp.lossFee"/>
            <result property="goldWeight"          column="lppp.goldWeight"/>
            <result property="mainStoneWeight"     column="lppp.mainStoneWeight"/>
			
			<result property="mainStonePrice"               column="lppp.mainStonePrice"/>
            <result property="subsidiaryStoneWeight"             column="lppp.subsidiaryStoneWeight"/>
            <result property="subsidiaryStonePrice"           column="lppp.subsidiaryStonePrice"/>
            <result property="workFee"             column="lppp.workFee"/>
            <result property="inlayFee"          column="lppp.inlayFee"/>
            <result property="templetFee"     column="lppp.templetFee"/>
			
			<result property="createBy.id"	 			column="lppp.createBy.id"/>
			<result property="createDate"	 			column="lppp.createDate"/>
			<result property="updateBy.id"	 			column="lppp.updateBy.id"/>
			<result property="updateDate"	 			column="lppp.updateDate"/>
			<result property="remarks"	 				column="lppp.remarks"/>
			<result property="delFlag"	 				column="lppp.delFlag"/>
			<collection property="purchaseProductList" 		ofType="PurchaseProduct">
				<result property="id" 						column="lpppt.id"/>
				<result property="purchaseProduce.id" 		column="lpppt.purchaseProduce.id"/>
				<result property="product.id" 				column="lpppt.product.id"/>
				<result property="product.code" 			column="lpppt.product.code"/>
				
				<result property="pricePurchase"			column="lpppt.pricePurchase"/>
				<result property="scanCode"               	column="lpppt.scanCode"/>
				<result property="regularFlag"				column="lpppt.regularFlag"/>
				
				<result property="inBatchNo"                column="lpppt.inBatchNo"/>
				
				<result property="supplierBatchNo" 			column="lpppt.supplierBatchNo"/>
				<result property="factoryCode" 				column="lpppt.factoryCode"/>
				<result property="certificateNo" 			column="lpppt.certificateNo"/>
				<result property="wareplace.id" 			column="lpppt.wareplace.id"/>
				<result property="wareplace.code" 			column="lpppt.wareplace.code"/>
				<result property="wareplace.warecounter.code"	column="lpppt.wareplace.warecounter.code"/>
				<result property="wareplace.warecounter.warearea.code"	column="lpppt.wareplace.warecounter.warearea.code"/>
				<result property="wareplace.warecounter.warearea.warehouse.code"	column="lpppt.wareplace.warecounter.warearea.warehouse.code"/>
				<result property="weight" 					column="lpppt.weight"/>
				<result property="createBy.id"	 			column="lpppt.createBy.id"/>
				<result property="createDate"	 			column="lpppt.createDate"/>
				<result property="updateBy.id"	 			column="lpppt.updateBy.id"/>
				<result property="updateDate"	 			column="lpppt.updateDate"/>
				<result property="remarks"	 				column="lpppt.remarks"/>
				<result property="delFlag"	 				column="lpppt.delFlag"/>
				<result property="enterPerson"              column="lppt.enterPerson"/>
                <result property="enterTime"                column="lppt.enterTime"/>
			</collection>
		</collection>
	</resultMap>
	<select id="getWithPurchaseProducesAndPurchaseProducts" resultMap="WithPurchaseProducesAndPurchaseProductsResult">
		SELECT
			a.id 					AS "id",
			a.purchase_mission_id 	AS "purchaseMission.id",
			lppm.batch_no 			AS "purchaseMission.batchNo",
			
			lppm.check_by           AS "purchaseMission.checkBy.id",
            lppm.check_time         AS "purchaseMission.checkTime",
            lppm.check_remarks      AS "purchaseMission.checkRemarks",
			
			a.order_no 				AS "orderNo",
			a.order_status 			AS "orderStatus",
			a.supplier_id 			AS "supplier.id",
			s.name		 			AS "supplier.name",
			a.purchase_user_id 		AS "purchaseUser.id",
			a.payable_amount 		AS "payableAmount",
			a.paid_amount 			AS "paidAmount",
			a.required_time 		AS "requiredTime",
			a.finish_time 			AS "finishTime",
			a.clearing_goldprice 	AS "clearingGoldprice",
			
			a.check_by              AS "checkBy.id",
            a.check_time             AS "checkTime",
            a.check_remarks          AS "checkRemarks",
			a.receive_time            AS "receiveTime",
			a.create_by 			AS "createBy.id",
			a.create_date 			AS "createDate",
			a.update_by 			AS "updateBy.id",
			a.update_date 			AS "updateDate",
			a.remarks 				AS "remarks",
			a.del_flag 				AS "delFlag",		
			lppp.id 					AS "lppp.id",
			lppp.purchase_order_id		AS "lppp.purchaseOrder.id",
			lppp.produce_id  			AS "produce.id",
			lpp.code 					AS "produce.code",
			lpp.name 					AS "produce.name",
			lpp.goods_id				AS "produce.goods.id",
			lpp.title					AS "produce.title",
			lpp.price_src				AS "produce.priceSrc",
			lpp.price_purchase          AS "produce.pricePurchase",
			lpg.name 					AS "produce.goods.name",
			lpg.title					AS "produce.goods.title",
			lpg.sample_photo            AS "produce.goods.samplePhoto",
			lpg.category_id             AS "produce.goods.category.id",
			
			
			lppp.required_num 			AS "lppp.requiredNum",
			lppp.reality_num 			AS "lppp.realityNum",
			lppp.reality_price 			AS "lppp.realityPrice",
			
			lppp.in_num                 AS "lppp.inNum",
	        lppp.back_num               AS "lppp.backNum",
	        lppp.gold_price             AS "lppp.goldPrice",
	        lppp.loss_fee               AS "lppp.lossFee", 
	        lppp.gold_weight            AS "lppp.goldWeight",
	        lppp.main_stone_weight      AS "lppp.mainStoneWeight", 
	        lppp.main_stone_price       AS "lppp.mainStonePrice",   
	        lppp.subsidiary_stone_weight    AS "lppp.subsidiaryStoneWeight",
	        lppp.subsidiary_stone_price     AS "lppp.subsidiaryStonePrice",
	        lppp.work_fee               AS "lppp.workFee",
	        lppp.inlay_fee              AS "lppp.inlayFee",
	        lppp.templet_fee            AS "lppp.templetFee",
			
			lppp.create_by				AS "lppp.createBy.id",
			lppp.create_date			AS "lppp.createDate",
			lppp.update_by				AS "lppp.updateBy.id",
			lppp.update_date			AS "lppp.updateDate",
			lppp.remarks				AS "lppp.remarks",
			lppp.del_flag				AS "lppp.delFlag",
			lpppt.id						AS "lpppt.id",
			lpppt.purchase_produce_id		AS "lpppt.purchaseProduce.id",
			lpppt.product_id				AS "lpppt.product.id",
			lppt.code						AS "lpppt.product.code",
			
			lpppt.price_purchase            AS "lpppt.pricePurchase",
			lpppt.scan_code                 AS "lpppt.scanCode",
			lpppt.regular_flag              AS "lpppt.regularFlag",
			
			lpppt.in_batch_no               AS "lpppt.inBatchNo",
			
			lpppt.supplier_batch_no			AS "lpppt.supplierBatchNo",
			lpppt.factory_code				AS "lpppt.factoryCode",
			lpppt.certificate_no			AS "lpppt.certificateNo",
			lpppt.wareplace_id				AS "lpppt.wareplace.id",
			wp.code							AS "lpppt.wareplace.code",
			wc.code							AS "lpppt.wareplace.warecounter.code",
			wa.code							AS "lpppt.wareplace.warecounter.warearea.code",
			wh.code							AS "lpppt.wareplace.warecounter.warearea.warehouse.code",
			lpppt.weight					AS "lpppt.weight",
			lpppt.create_by					AS "lpppt.createBy.id",
			lpppt.create_date				AS "lpppt.createDate",
			lpppt.update_by					AS "lpppt.updateBy.id",
			lpppt.update_date				AS "lpppt.updateDate",
			lpppt.remarks					AS "lpppt.remarks",
			lpppt.del_flag					AS "lpppt.delFlag"
		FROM lgt_po_purchase_order a
		LEFT JOIN lgt_po_purchase_mission lppm 	ON lppm.id=a.purchase_mission_id
		LEFT JOIN lgt_si_supplier s		 		ON s.id=a.supplier_id
		LEFT JOIN lgt_po_purchase_produce lppp 	ON lppp.purchase_order_id=a.id AND lppp.del_flag = '0'
		LEFT JOIN lgt_ps_produce lpp 			ON lpp.id=lppp.produce_id
		LEFT JOIN lgt_ps_goods lpg 				ON lpg.id=lpp.goods_id
		LEFT JOIN lgt_po_purchase_product lpppt	ON lpppt.purchase_produce_id=lppp.id AND lpppt.del_flag = '0'
		LEFT JOIN lgt_ps_product lppt			ON lppt.id=lpppt.product_id
		LEFT JOIN lgt_ps_wareplace wp 			ON wp.id=lpppt.wareplace_id
		LEFT JOIN lgt_ps_warecounter wc 		ON wc.id=wp.warecounter_id
		LEFT JOIN lgt_ps_warearea wa 			ON wa.id=wc.warearea_id
		LEFT JOIN lgt_ps_warehouse wh 			ON wh.id=wa.warehouse_id
		WHERE a.id = #{id}
		ORDER BY  lpppt.in_batch_no, lpppt.scan_code
	</select>
	
	<select id="findList" resultType="PurchaseOrder">
		SELECT
			a.id AS "id",
			a.purchase_mission_id AS "purchaseMission.id",
			m.batch_no AS "purchaseMission.batchNo",
			lgtPt.code AS "productCode",
			a.order_no AS "orderNo",
			a.order_status AS "orderStatus",
			a.supplier_id AS "supplier.id",
			s.name AS "supplier.name",
			a.purchase_user_id AS "purchaseUser.id",
			a.payable_amount AS "payableAmount",
			a.paid_amount AS "paidAmount",
			a.required_time AS "requiredTime",
			a.finish_time AS "finishTime",
			a.clearing_goldprice AS "clearingGoldprice",
			a.check_by AS "checkBy.id",
            a.check_time AS "checkTime",
            a.check_remarks AS "checkRemarks",
			a.create_by AS "createBy.id",
			a.create_date AS "createDate",
			a.update_by AS "updateBy.id",
			a.update_date AS "updateDate",
			a.remarks AS "remarks",
			a.del_flag AS "delFlag",
			COUNT(DISTINCT a.id)
		FROM lgt_po_purchase_order a
		LEFT JOIN lgt_po_purchase_mission m ON m.id=a.purchase_mission_id
		LEFT JOIN lgt_si_supplier s ON s.id=a.supplier_id
		LEFT JOIN lgt_po_purchase_produce pp ON pp.purchase_order_id=a.id
		LEFT JOIN lgt_po_purchase_product pt ON pp.id=pt.purchase_produce_id
		LEFT JOIN lgt_ps_product lgtPt ON pt.product_id=lgtPt.id
		<where>
			a.del_flag = #{DEL_FLAG_NORMAL}
			<if test="orderNo != null and orderNo != ''">
				AND a.order_no = #{orderNo}
			</if>
			<if test="orderStatus != null and orderStatus != ''">
				AND a.order_status = #{orderStatus}
			</if>
			<if test="supplier != null and supplier.id != null and supplier.id != ''">
				AND a.supplier_id = #{supplier.id}
			</if>
			<if test="purchaseUser != null and purchaseUser.id != null and purchaseUser.id != ''"><!-- 采购人 -->
				AND a.purchase_user_id = #{purchaseUser.id}
			</if>
			<if test="createBy != null and createBy.id != null and createBy.id != ''"><!-- 下单人 -->
                AND a.create_by = #{createBy.id}
            </if>
			<if test="beginRequiredTime != null and beginRequiredTime != ''">
				<![CDATA[AND a.required_time >= #{beginRequiredTime}]]>
			</if>
			<if test="endRequiredTime != null and endRequiredTime != ''">
				<![CDATA[AND a.required_time <= #{endRequiredTime}]]>
			</if>
			<if test="startOrderStatus != null and startOrderStatus != ''">
				AND a.order_status >= #{startOrderStatus}
			</if>
			<if test="purchaseMission != null and purchaseMission.batchNo != null and purchaseMission.batchNo != ''">
			    AND m.batch_no = #{purchaseMission.batchNo}
			</if>
			<if test="productCode != null and productCode != ''">
				AND lgtPt.code = #{productCode}
			</if>
			<if test="beginEnterTime != null and beginEnterTime != ''">
				<![CDATA[AND pt.enter_time >= #{beginEnterTime}]]>
			</if>
			<if test="endEnterTime != null and endEnterTime != ''">
				<![CDATA[AND pt.enter_time <= #{endEnterTime}]]>
			</if>
		</where>
		GROUP BY a.id
		<choose>
			<when test="page !=null and page.orderBy != null and page.orderBy != ''">
				ORDER BY ${page.orderBy}
			</when>
			<otherwise>
				ORDER BY a.create_date DESC
			</otherwise>
		</choose>
	</select>
	
	<select id="findAllList" resultType="PurchaseOrder">
		SELECT 
			<include refid="purchaseOrderColumns"/>
		FROM lgt_po_purchase_order a
		<include refid="purchaseOrderJoins"/>
		<where>
			a.del_flag = #{DEL_FLAG_NORMAL}
		</where>		
		<choose>
			<when test="page !=null and page.orderBy != null and page.orderBy != ''">
				ORDER BY ${page.orderBy}
			</when>
			<otherwise>
				ORDER BY a.create_date DESC
			</otherwise>
		</choose>
	</select>
	
	<select id="findCount" resultType="Integer">
		SELECT count(id) FROM lgt_po_purchase_order
	</select>
	
	<select id="findUnfinishOrderCount" resultType="Integer">
		SELECT count(a.id) 
		FROM lgt_po_purchase_order a
		WHERE a.purchase_mission_id = #{mid}
			AND a.id != #{oid}
			AND (a.order_status != #{ostatus} AND a.order_status != 99)
	</select>
	
	
	<!-- 批量插入 -->
	<insert id="insertList">
		INSERT INTO lgt_po_purchase_order(
			id,
			purchase_mission_id,
			order_no,
			order_status,
			supplier_id,
			purchase_user_id,
			payable_amount,
			paid_amount,
			required_time,
			finish_time,
			clearing_goldprice,
			check_by,
			check_time,
			check_remarks,
			create_by,
			create_date,
			update_by,
			update_date,
			remarks,
			del_flag
		) VALUES 
	 	<foreach collection="list" item="item" index="index" separator=",">
	 		(
	 		#{item.id},
			#{item.purchaseMission.id},
			#{item.orderNo},
			#{item.orderStatus},
			#{item.supplier.id},
			#{item.purchaseUser.id},
			#{item.payableAmount},
			#{item.paidAmount},
			#{item.requiredTime},
			#{item.finishTime},
			#{item.clearingGoldprice},
			#{item.checkBy.id},
			#{item.checkTime},
			#{item.checkRemarks},
			#{item.createBy.id},
			#{item.createDate},
			#{item.updateBy.id},
			#{item.updateDate},
			#{item.remarks},
			#{item.delFlag}
			)
	    </foreach>  
	</insert>
	
	<insert id="insert">
		INSERT INTO lgt_po_purchase_order(
			id,
			purchase_mission_id,
			order_no,
			order_status,
			supplier_id,
			purchase_user_id,
			payable_amount,
			paid_amount,
			required_time,
			finish_time,
			receive_time,
			clearing_goldprice,
			check_by,
            check_time,
            check_remarks,
			create_by,
			create_date,
			update_by,
			update_date,
			remarks,
			del_flag
		) VALUES (
			#{id},
			#{purchaseMission.id},
			#{orderNo},
			#{orderStatus},
			#{supplier.id},
			#{purchaseUser.id},
			#{payableAmount},
			#{paidAmount},
			#{requiredTime},
			#{finishTime},
			#{receiveTime},
			#{clearingGoldprice},
			#{checkBy.id},
            #{checkTime},
            #{checkRemarks},
			#{createBy.id},
			#{createDate},
			#{updateBy.id},
			#{updateDate},
			#{remarks},
			#{delFlag}
		)
	</insert>
	
	<update id="update">
		UPDATE lgt_po_purchase_order SET 
			purchase_mission_id = #{purchaseMission.id},	
			order_no = #{orderNo},
			order_status = #{orderStatus},
			supplier_id = #{supplier.id},
			purchase_user_id = #{purchaseUser.id},
			payable_amount = #{payableAmount},
			paid_amount = #{paidAmount},
			required_time = #{requiredTime},
			finish_time = #{finishTime},
			receive_time = #{receiveTime},
			clearing_goldprice = #{clearingGoldprice},
			update_by = #{updateBy.id},
			update_date = #{updateDate},
			remarks = #{remarks}
		WHERE id = #{id}
	</update>
	
	<update id="delete">
		UPDATE lgt_po_purchase_order SET 
			del_flag = #{DEL_FLAG_DELETE}
		WHERE id = #{id}
	</update>
	
	<delete id="remove">
		DELETE FROM lgt_po_purchase_order WHERE id = #{id}
	</delete>
	
	<sql id="purchaseColumns">
		a.id AS "id",
		a.purchase_mission_id AS "mission.id",
		a.order_no AS "orderNo",
		a.supplier_id AS "supplier.id",
		a.purchase_user_id AS "purchaseUser.id",
		a.payable_amount AS "payableAmount",
		a.paid_amount AS "paidAmount",
		a.order_status AS "orderStatus",
		a.required_time AS "requiredTime",
		a.finish_time AS "finishTime",
		a.clearing_goldprice AS "clearingGoldprice",
		a.check_by AS "checkBy.id",
        a.check_time AS "checkTime",
        a.check_remarks AS "checkRemarks",
		a.create_by AS "createBy.id",
		a.create_date AS "createDate",
		a.update_by AS "updateBy.id",
		a.update_date AS "updateDate",
		a.remarks AS "remarks",
		a.del_flag AS "delFlag"
	</sql>
	
	<resultMap id="PurchaseWithChildResult" type="com.chinazhoufan.admin.modules.lgt.entity.po.PurchaseOrder">
		<result property="id" 					column="id"/>
		<result property="purchaseMission.id" 	column="mission.id"/>
		<result property="orderNo" 				column="orderNo"/>
		<result property="supplier.id" 			column="supplier.id"/>
		<result property="purchaseUser.id" 		column="purchaseUser.id"/>
		<result property="payableAmount" 		column="payableAmount"/>
		<result property="paidAmount" 			column="paidAmount"/>
		<result property="orderStatus" 			column="orderStatus"/>
		<result property="requiredTime" 		column="requiredTime"/>
		<result property="finishTime" 			column="finishTime"/>
		<result property="clearingGoldprice" 	column="clearingGoldprice"/>
		
		<result property="checkBy.id"               column="checkBy.id"/>
        <result property="checkTime"                column="checkTime"/>
        <result property="checkRemarks"             column="checkRemarks"/>
		
		<result property="createBy.id" 			column="createBy.id"/>
		<result property="createDate" 			column="createDate"/>
		<result property="updateBy.id" 			column="updateBy.id"/>
		<result property="updateDate" 			column="updateDate"/>
		<result property="remarks" 				column="remarks"/>
		<result property="delFlag" 				column="delFlag"/>
		<collection property="purchaseProduceList" ofType="PurchaseProduce">
			<result property="id" 						column="lppp.id"/>
			<result property="produce.id" 				column="produce.id"/>
			<result property="produce.name"	 			column="produce.name"/>
			<result property="requiredNum" 				column="lppp.requiredNum"/>
			<result property="realityNum" 				column="lppp.realityNum"/>
			<result property="realityPrice" 			column="lppp.realityPrice"/>
		</collection>
	</resultMap>
	<select id="listPurchaseOrderForSupplier" resultMap="PurchaseWithChildResult">
		SELECT
			<include refid="purchaseColumns"/>
		FROM lgt_po_purchase_order a
		INNER JOIN lgt_si_supplier s ON a.supplier_id = s.id
		<where>
 			a.del_flag = #{purchaseOrder.DEL_FLAG_NORMAL}
			<if test="sysUserId != null and sysUserId != ''">
				AND s.sys_user_id = #{sysUserId}
 			</if> 
			<if test="purchaseOrder != null and purchaseOrder.beginRequiredTime != null and purchaseOrder.beginRequiredTime != ''">
				<![CDATA[AND a.required_time >= #{purchaseOrder.beginRequiredTime}]]>
			</if>
			<if test="purchaseOrder != null and purchaseOrder.endRequiredTime != null and purchaseOrder.endRequiredTime != ''">
				<![CDATA[AND a.required_time <= #{purchaseOrder.endRequiredTime}]]>
			</if>
		</where>
		<choose>
			<when test="page !=null and page.orderBy != null and page.orderBy != ''">
				ORDER BY ${page.orderBy}
			</when>
			<otherwise>
				ORDER BY a.create_date DESC
			</otherwise>
		</choose>
	</select>
	
	
	
	<!-- 导出   START -->
	<resultMap type="PurchaseOrder" id="purchaseOrderWithProduceMap">
	   <result column="orderNo"  property="orderNo"/>
	   <result column="sname"  property="supplier.name"/>
	   <result column="createDate"  property="createDate"/>
	   <result column="requiredTime"  property="requiredTime"/>
	   <collection property="purchaseProduceList" ofType="PurchaseProduce">
		   <result column="goodsFactoryCode"  property="goodsFactoryCode"/>
		   <result column="electrolyticGoldCrafts"  property="electrolyticGoldCrafts"/>
		   <result column="electrolyticGoldThickness"  property="electrolyticGoldThickness"/>
		   <result column="gcode"  property="produce.goods.code"/>
		   <result column="gname"  property="produce.goods.name"/>
		   <result column="pcode"  property="produce.code"/>
		   <result column="pname"  property="produce.name"/>
		   <result column="rnum"  property="requiredNum"/>
	   </collection>
	</resultMap>
	<select id="export" resultMap="purchaseOrderWithProduceMap">
		SELECT  
		po.order_no AS "orderNo",
		s.name AS "sname",
		po.create_date AS "createDate",
		po.required_time AS "requiredTime",
		sp.goods_factory_code AS "goodsFactoryCode",
		sp.electrolytic_gold_crafts AS "electrolyticGoldCrafts",
		sp.electrolytic_gold_thickness AS  "electrolyticGoldThickness",
		g.code AS "gcode",
		g.name AS "gname",
		p.code AS "pcode",
		p.name AS "pname",
		pp.required_num AS "rnum"
		FROM lgt_po_purchase_order po 
		LEFT JOIN lgt_si_supplier s ON s.id = po.supplier_id 
		LEFT JOIN lgt_po_purchase_produce pp ON pp.purchase_order_id = po.id
		LEFT JOIN lgt_si_supplier_produce sp ON sp.supplier_id = s.id AND sp.produce_id = pp.produce_id
		LEFT JOIN lgt_ps_produce p ON p.id = pp.produce_id
		LEFT JOIN lgt_ps_goods g ON g.id = p.goods_id
		<where>
		  po.del_flag = #{DEL_FLAG_NORMAL}
		 <!--  AND po.id = #{id} -->
		</where>
		ORDER BY po.create_date ASC
	</select>
	<!-- 导出   END -->
	
	
	
	
	
	
	
	
	
	
	
	
	
	
	<update id="saveCheckResult">
         UPDATE lgt_po_purchase_order SET 
               order_status = #{orderStatus},
               check_by = #{checkBy.id},
               check_time = #{checkTime},
               check_remarks = #{checkRemarks},
               update_by = #{updateBy.id},
               update_date = #{updateDate}
         WHERE id = #{id}   
    </update>
	
	
	<update id="updatePayableAmount">
	   UPDATE lgt_po_purchase_order SET 
               payable_amount = #{payableAmount},
               update_by = #{updateBy.id},
               update_date = #{updateDate}
         WHERE id = #{id} 
	</update>
	
	
	<resultMap type="PurchaseOrder" id="purchaseOrderWithProductMap">
      <result property="id"                         column="id"/>
        <result property="purchaseMission.id"       column="purchaseMission.id"/>
        <result property="purchaseMission.batchNo"  column="purchaseMission.batchNo"/>
        <result property="orderNo"                  column="orderNo"/>
        <result property="supplier.id"              column="supplier.id"/>
        <result property="supplier.name"            column="supplier.name"/>
        <result property="purchaseUser.id"          column="purchaseUser.id"/>
        <result property="payableAmount"            column="payableAmount"/>
        <result property="paidAmount"               column="paidAmount"/>
        <result property="requiredTime"             column="requiredTime"/>
        <result property="finishTime"               column="finishTime"/>
        <result property="delFlag"                  column="delFlag"/>
        <collection property="purchaseProduceList"      ofType="PurchaseProduce">
            <result property="id"                       column="lppp.id"/>
            <result property="purchaseOrder.id"         column="lppp.purchaseOrder.id"/>
            <result property="produce.id"               column="produce.id"/>
            <result property="produce.code"             column="produce.code"/>
            <result property="produce.name"             column="produce.name"/>
            <result property="produce.title"                column="produce.title"/>
            <result property="produce.priceSrc"             column="produce.priceSrc"/>
            <result property="produce.pricePurchase"     column="produce.pricePurchase"/>
            
            <result property="produce.goods.id"         column="produce.goods.id"/>
            <result property="produce.goods.name"       column="produce.goods.name"/>
            <result property="produce.goods.title"      column="produce.goods.title"/>
            <result property="produce.goods.code"      column="produce.goods.code"/>
            <result property="produce.goods.samplePhoto" column="produce.goods.samplePhoto"/>
            <result property="produce.goods.category.id" column="produce.goods.category.id"/>
            
            <result property="requiredNum"              column="lppp.requiredNum"/>
            <result property="realityNum"               column="lppp.realityNum"/>
            <result property="realityPrice"             column="lppp.realityPrice"/>
            <result property="mainStonePrice"               column="lppp.mainStonePrice"/>
            <result property="subsidiaryStoneWeight"             column="lppp.subsidiaryStoneWeight"/>
            <result property="subsidiaryStonePrice"           column="lppp.subsidiaryStonePrice"/>
            <result property="workFee"             column="lppp.workFee"/>
            <result property="inlayFee"          column="lppp.inlayFee"/>
            <result property="templetFee"     column="lppp.templetFee"/>
            <result property="delFlag"                  column="lppp.delFlag"/>
            <collection property="purchaseProductList"      ofType="PurchaseProduct">
                <result property="id"                       column="lpppt.id"/>
                <result property="purchaseProduce.id"       column="lpppt.purchaseProduce.id"/>
                <result property="product.id"               column="lpppt.product.id"/>
                <result property="product.code"             column="lpppt.product.code"/>
                <result property="pricePurchase"            column="lpppt.pricePurchase"/>
                <result property="regularFlag"              column="lpppt.regularFlag"/>
                <result property="supplierBatchNo"          column="lpppt.supplierBatchNo"/>
                <result property="factoryCode"              column="lpppt.factoryCode"/>
                <result property="certificateNo"            column="lpppt.certificateNo"/>
                <result property="wareplace.id"             column="lpppt.wareplace.id"/>
                <result property="wareplace.code"           column="lpppt.wareplace.code"/>
                <result property="wareplace.warecounter.code"   column="lpppt.wareplace.warecounter.code"/>
                <result property="wareplace.warecounter.warearea.code"  column="lpppt.wareplace.warecounter.warearea.code"/>
                <result property="wareplace.warecounter.warearea.warehouse.code"    column="lpppt.wareplace.warecounter.warearea.warehouse.code"/>
                <result property="delFlag"                  column="lpppt.delFlag"/>
            </collection>
        </collection>
    </resultMap>
    <select id="findProductList" resultMap="WithPurchaseProducesAndPurchaseProductsResult">
        SELECT
			a.id 					AS "id",
			a.purchase_mission_id 	AS "purchaseMission.id",
			lppm.batch_no 			AS "purchaseMission.batchNo",
			lppm.check_by           AS "purchaseMission.checkBy.id",
            lppm.check_time         AS "purchaseMission.checkTime",
            lppm.check_remarks      AS "purchaseMission.checkRemarks",
			a.order_no 				AS "orderNo",
			a.order_status 			AS "orderStatus",
			a.supplier_id 			AS "supplier.id",
			s.name		 			AS "supplier.name",
			a.purchase_user_id 		AS "purchaseUser.id",
			a.payable_amount 		AS "payableAmount",
			a.paid_amount 			AS "paidAmount",
			a.required_time 		AS "requiredTime",
			a.finish_time 			AS "finishTime",
			a.receive_time          AS "receiveTime",
			a.clearing_goldprice 	AS "clearingGoldprice",
			a.check_by              AS "checkBy.id",
            a.check_time             AS "checkTime",
            a.check_remarks          AS "checkRemarks",
			a.receive_time            AS "receiveTime",
			a.create_by 			AS "createBy.id",
			a.create_date 			AS "createDate",
			a.update_by 			AS "updateBy.id",
			a.update_date 			AS "updateDate",
			a.remarks 				AS "remarks",
			a.del_flag 				AS "delFlag",		
			lppp.id 					AS "lppp.id",
			lppp.purchase_order_id		AS "lppp.purchaseOrder.id",
			lppp.produce_id  			AS "produce.id",
			lpp.code 					AS "produce.code",
			lpp.name 					AS "produce.name",
			lpp.goods_id				AS "produce.goods.id",
			lpp.title					AS "produce.title",
			lpp.price_src				AS "produce.priceSrc",
			lpp.price_purchase          AS "produce.pricePurchase",
			lpg.name 					AS "produce.goods.name",
			lpg.code 					AS "produce.goods.code",
			lpg.title					AS "produce.goods.title",
			lpg.sample_photo            AS "produce.goods.samplePhoto",
			lpg.category_id             AS "produce.goods.category.id",
			lppp.required_num 			AS "lppp.requiredNum",
			lppp.reality_num 			AS "lppp.realityNum",
			lppp.reality_price 			AS "lppp.realityPrice",
			lppp.in_num                 AS "lppp.inNum",
	        lppp.back_num               AS "lppp.backNum",
	        lppp.gold_price             AS "lppp.goldPrice",
	        lppp.loss_fee               AS "lppp.lossFee", 
	        lppp.gold_weight            AS "lppp.goldWeight",
	        lppp.main_stone_weight      AS "lppp.mainStoneWeight", 
	        lppp.main_stone_price       AS "lppp.mainStonePrice",   
	        lppp.subsidiary_stone_weight    AS "lppp.subsidiaryStoneWeight",
	        lppp.subsidiary_stone_price     AS "lppp.subsidiaryStonePrice",
	        lppp.work_fee               AS "lppp.workFee",
	        lppp.inlay_fee              AS "lppp.inlayFee",
	        lppp.templet_fee            AS "lppp.templetFee",
			lppp.create_by				AS "lppp.createBy.id",
			lppp.create_date			AS "lppp.createDate",
			lppp.update_by				AS "lppp.updateBy.id",
			lppp.update_date			AS "lppp.updateDate",
			lppp.remarks				AS "lppp.remarks",
			lppp.del_flag				AS "lppp.delFlag",
			lpppt.id						AS "lpppt.id",
			lpppt.purchase_produce_id		AS "lpppt.purchaseProduce.id",
			lpppt.product_id				AS "lpppt.product.id",
			lppt.code						AS "lpppt.product.code",
			lpppt.price_purchase            AS "lpppt.pricePurchase",
			lpppt.scan_code                 AS "lpppt.scanCode",
			lpppt.regular_flag              AS "lpppt.regularFlag",
			lpppt.in_batch_no               AS "lpppt.inBatchNo",
			lpppt.supplier_batch_no			AS "lpppt.supplierBatchNo",
			lpppt.factory_code				AS "lpppt.factoryCode",
			lpppt.certificate_no			AS "lpppt.certificateNo",
			lpppt.wareplace_id				AS "lpppt.wareplace.id",
			wp.code							AS "lpppt.wareplace.code",
			wc.code							AS "lpppt.wareplace.warecounter.code",
			wa.code							AS "lpppt.wareplace.warecounter.warearea.code",
			wh.code							AS "lpppt.wareplace.warecounter.warearea.warehouse.code",
			lpppt.weight					AS "lpppt.weight",
			lpppt.create_by					AS "lpppt.createBy.id",
			lpppt.create_date				AS "lpppt.createDate",
			lpppt.update_by					AS "lpppt.updateBy.id",
			lpppt.update_date				AS "lpppt.updateDate",
			lpppt.remarks					AS "lpppt.remarks",
			lpppt.del_flag					AS "lpppt.delFlag",
			lpppt.regular_flag    AS      "lpppt.regularFlag",
			lppt.id AS "id",
			lppt.produce_id AS "lppt.produce.id",
			lppt.goods_id AS "lppt.goods.id",
			lppt.code AS "code",
			lppt.factory_code AS "lppt.factoryCode",
			lppt.certificate_no AS "lppt.certificateNo",
			lppt.status AS "lppt.status",
			lppt.status_logistics AS "lppt.statusLogistics",
			lppt.wareplace_id AS "lppt.wareplace.id",
			lppt.hold_user_id AS "lppt.holdUser.id",
			lppt.weight AS "lppt.weight",
			lppt.create_by AS "lppt.createBy.id",
			lppt.create_date AS "lppt.createDate",
			lppt.update_by AS "lppt.updateBy.id",
			lppt.update_date AS "lppt.updateDate",
			lppt.remarks AS "lppt.remarks",
			lppt.del_flag AS "lppt.delFlag",
			lpppt.enter_time AS "lppt.enterTime",
            lpppt.enter_person AS "lppt.enterPerson"
		     FROM lgt_po_purchase_order a
		LEFT JOIN lgt_po_purchase_mission lppm 	ON lppm.id=a.purchase_mission_id
		LEFT JOIN lgt_si_supplier s		 		ON s.id=a.supplier_id
		LEFT JOIN lgt_po_purchase_produce lppp 	ON lppp.purchase_order_id=a.id AND lppp.del_flag = '0'
		LEFT JOIN lgt_ps_produce lpp 			ON lpp.id=lppp.produce_id
		LEFT JOIN lgt_ps_goods lpg 				ON lpg.id=lpp.goods_id
		LEFT JOIN lgt_po_purchase_product lpppt	ON lpppt.purchase_produce_id=lppp.id AND lpppt.del_flag = '0'
		LEFT JOIN lgt_ps_product lppt			ON lppt.id=lpppt.product_id
		LEFT JOIN lgt_ps_wareplace wp 			ON wp.id=lpppt.wareplace_id
		LEFT JOIN lgt_ps_warecounter wc 		ON wc.id=wp.warecounter_id
		LEFT JOIN lgt_ps_warearea wa 			ON wa.id=wc.warearea_id
		LEFT JOIN lgt_ps_warehouse wh 			ON wh.id=wa.warehouse_id
		<where>
			a.del_flag = #{DEL_FLAG_NORMAL}
			<if test="orderNo != null and orderNo != ''">
				AND a.order_no = #{orderNo}
			</if>
			<if test="orderStatus != null and orderStatus != ''">
				AND a.order_status = #{orderStatus}
			</if>
			<if test="supplier != null and supplier.id != null and supplier.id != ''">
				AND a.supplier_id = #{supplier.id}
			</if>
			<if test="purchaseUser != null and purchaseUser.id != null and purchaseUser.id != ''"><!-- 采购人 -->
				AND a.purchase_user_id = #{purchaseUser.id}
			</if>
			<if test="createBy != null and createBy.id != null and createBy.id != ''"><!-- 下单人 -->
                AND a.create_by = #{createBy.id}
            </if>
			<if test="startOrderStatus != null and startOrderStatus != ''">
				AND a.order_status >= #{startOrderStatus}
			</if>
			<if test="purchaseMission != null and purchaseMission.batchNo != null and purchaseMission.batchNo != ''">
			    AND lppm.batch_no = #{purchaseMission.batchNo}
			</if>
			<if test="productCode != null and productCode != ''">
				AND lgtPt.code = #{productCode}
			</if>
			<if test="beginEnterTime != null and beginEnterTime != ''">
				<![CDATA[AND lpppt.enter_time >= #{beginEnterTime}]]>
			</if>
			<if test="endEnterTime != null and endEnterTime != ''">
				<![CDATA[AND lpppt.enter_time <= #{endEnterTime}]]>
			</if>
		</where>
		order by a.order_no desc
    </select>
</mapper>